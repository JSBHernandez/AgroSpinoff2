/**
 * SCRIPT DE MIGRACI√ìN E INICIALIZACI√ìN - AGROTECHNOVA
 * 
 * Este script:
 * 1. Crea las tablas necesarias (roles, usuarios, categor√≠as, proyectos, fases, hitos)
 * 2. Inserta roles y categor√≠as por defecto
 * 3. Crea usuario administrador por defecto (RF48)
 * 
 * Sprint 1: Autenticaci√≥n (roles, usuarios)
 * Sprint 2: Gesti√≥n de Proyectos (categor√≠as, proyectos, fases, hitos)
 * 
 * Ejecutar: node src/db/migrations.js
 */

const db = require('./database');
const RoleModel = require('../models/roleModel');
const UserModel = require('../models/userModel');
const CategoryModel = require('../models/categoryModel');
const ProjectModel = require('../models/projectModel');
const PhaseModel = require('../models/phaseModel');
const MilestoneModel = require('../models/milestoneModel');

async function runMigrations() {
  console.log('üöÄ Iniciando migraciones de base de datos...\n');

  try {
    // 1. Inicializar conexi√≥n a la base de datos
    console.log('üì¶ Paso 1: Inicializando base de datos...');
    await db.initialize();
    console.log('‚úÖ Base de datos inicializada\n');

    // 2. Crear tabla de roles
    console.log('üì¶ Paso 2: Creando tabla de roles...');
    await RoleModel.createTable();
    console.log('‚úÖ Tabla de roles creada\n');

    // 3. Crear tabla de usuarios
    console.log('üì¶ Paso 3: Creando tabla de usuarios...');
    await UserModel.createTable();
    console.log('‚úÖ Tabla de usuarios creada\n');

    // 4. Insertar roles por defecto
    console.log('üì¶ Paso 4: Insertando roles por defecto...');
    await RoleModel.seedDefaultRoles();
    console.log('‚úÖ Roles por defecto insertados\n');

    // 5. Crear usuario administrador por defecto (RF48)
    console.log('üì¶ Paso 5: Creando usuario administrador...');
    await UserModel.seedDefaultAdmin();
    console.log('‚úÖ Usuario administrador creado\n');

    // 6. Crear tabla de categor√≠as de proyecto (Sprint 2 - RF23)
    console.log('üì¶ Paso 6: Creando tabla de categor√≠as de proyecto...');
    await CategoryModel.createTable();
    console.log('‚úÖ Tabla de categor√≠as creada\n');

    // 7. Insertar categor√≠as por defecto (Sprint 2 - RF23)
    console.log('üì¶ Paso 7: Insertando categor√≠as por defecto...');
    await CategoryModel.seedDefaultCategories();
    console.log('‚úÖ Categor√≠as por defecto insertadas\n');

    // 8. Crear tabla de proyectos (Sprint 2 - RF41)
    console.log('üì¶ Paso 8: Creando tabla de proyectos...');
    await ProjectModel.createTable();
    console.log('‚úÖ Tabla de proyectos creada\n');

    // 9. Crear tabla de fases (Sprint 2 - RF13)
    console.log('üì¶ Paso 9: Creando tabla de fases...');
    await PhaseModel.createTable();
    console.log('‚úÖ Tabla de fases creada\n');

    // 10. Crear tabla de hitos (Sprint 2 - RF25)
    console.log('üì¶ Paso 10: Creando tabla de hitos...');
    await MilestoneModel.createTable();
    console.log('‚úÖ Tabla de hitos creada\n');

    console.log('='.repeat(50));
    console.log('‚ú® MIGRACIONES COMPLETADAS EXITOSAMENTE');
    console.log('='.repeat(50));
    console.log('\nüìã CREDENCIALES DE ADMINISTRADOR:');
    console.log('   üìß Email: admin@agrotechnova.com');
    console.log('   üîë Password: Admin123!');
    console.log('\n‚ö†Ô∏è  IMPORTANTE: Cambiar la contrase√±a despu√©s del primer login\n');

    // 11. Mostrar estad√≠sticas
    const usuarios = await UserModel.findAll();
    const roles = await RoleModel.findAll();
    const categorias = await CategoryModel.findAll();
    
    console.log('üìä RESUMEN:');
    console.log(`   - Roles creados: ${roles.length}`);
    console.log(`   - Usuarios creados: ${usuarios.length}`);
    console.log(`   - Categor√≠as de proyecto: ${categorias.length}`);
    console.log('   - Tablas Sprint 1: roles, usuarios');
    console.log('   - Tablas Sprint 2: categorias_proyecto, proyectos, fases, hitos');
    console.log('');

  } catch (error) {
    console.error('\n‚ùå ERROR EN MIGRACIONES:');
    console.error(error);
    process.exit(1);
  }
}

/**
 * Inicializaci√≥n de base de datos (sin inicializar conexi√≥n)
 * Para usar cuando la conexi√≥n ya est√° activa
 */
async function initDatabase() {
  try {
    // Sprint 1: Autenticaci√≥n
    await RoleModel.createTable();
    await UserModel.createTable();
    await RoleModel.seedDefaultRoles();
    await UserModel.seedDefaultAdmin();

    // Sprint 2: Gesti√≥n de Proyectos
    await CategoryModel.createTable();
    await CategoryModel.seedDefaultCategories();
    await ProjectModel.createTable();
    await PhaseModel.createTable();
    await MilestoneModel.createTable();

  } catch (error) {
    // Si las tablas ya existen, no es error fatal
    if (error.message && error.message.includes('already exists')) {
      console.log('‚ÑπÔ∏è  Tablas ya existentes, continuando...');
    } else {
      throw error;
    }
  }
}

// Ejecutar migraciones
if (require.main === module) {
  runMigrations()
    .then(() => {
      console.log('üëã Migraciones finalizadas. Cerrando conexi√≥n...');
      process.exit(0);
    })
    .catch((error) => {
      console.error('‚ùå Error fatal:', error);
      process.exit(1);
    });
}

module.exports = { runMigrations, initDatabase };
