<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Principal - AgroTechNova</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../public/css/dashboard.css">
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="logo">
      <img src="../images/logo.png" alt="Logo">
      <h2>AgroTechNova</h2>
    </div>

    <div class="menu">
      <!-- Sprint 1: Gestión de Usuarios -->
      <a href="usuarios.html" id="menuUsuarios"><i class="fas fa-users"></i> Gestión de Usuarios</a>
      
      <!-- Sprint 2: Gestión de Proyectos -->
      <a href="proyectos.html"><i class="fas fa-project-diagram"></i> Gestión de Proyectos</a>
      
      <!-- Otras funcionalidades -->
      <a href="agendaReuniones.html"><i class="fas fa-calendar-check"></i> Agenda de Reuniones</a>
      <a href="contacto.html"><i class="fas fa-envelope"></i> Contacto</a>
      <a href="mision-vision.html"><i class="fas fa-bullseye"></i> Misión y Visión</a>
      <a href="objetivos.html"><i class="fas fa-tasks"></i> Objetivos</a>
      <a href="servicios.html"><i class="fas fa-briefcase"></i> Servicios</a>
    </div>
  </aside>

  <!-- Fondo oscuro -->
  <div class="overlay" id="overlay"></div>

  <!-- Topbar -->
  <div class="topbar">
    <button class="menu-btn" id="menuBtn"><i class="fas fa-bars"></i></button>
    <button class="logout-btn" onclick="cerrarSesion()">Cerrar Sesión</button>
  </div>

  <!-- Contenido principal -->
  <main class="main">
    <h1>¡Bienvenido, <span id="usuarioNombre">Usuario</span>! </h1>
    <p>Nos alegra tenerte de nuevo en AgroTechNova</p>

    <section class="destacado">
      <h2>🚀 Funcionalidades Disponibles</h2>
      <div class="cards-container">
        <div class="card" onclick="window.location.href='usuarios.html'">
          <i class="fas fa-users fa-3x"></i>
          <h3>Gestión de Usuarios</h3>
          <p>Administra usuarios, roles y permisos del sistema</p>
        </div>
        
        <div class="card" onclick="window.location.href='proyectos.html'">
          <i class="fas fa-project-diagram fa-3x"></i>
          <h3>Gestión de Proyectos</h3>
          <p>Crea y administra proyectos, fases e hitos</p>
        </div>
        
        <div class="card" onclick="window.location.href='agendaReuniones.html'">
          <i class="fas fa-calendar-check fa-3x"></i>
          <h3>Agenda de Reuniones</h3>
          <p>Programa y gestiona reuniones del equipo</p>
        </div>
      </div>

      <h3 style="margin-top: 2rem;">📊 Gestión Financiera y Recursos (Sprint 3)</h3>
      <div class="cards-container" id="sprint3Cards" style="margin-top: 1rem;">
        <div class="card" onclick="irARecursos()">
          <i class="fas fa-tools fa-3x"></i>
          <h3>Recursos</h3>
          <p>Gestiona recursos, materiales y equipos por proyecto</p>
        </div>
        
        <div class="card" onclick="irAPresupuestos()">
          <i class="fas fa-dollar-sign fa-3x"></i>
          <h3>Presupuestos</h3>
          <p>Administra presupuestos y controla gastos</p>
        </div>
        
        <div class="card" onclick="irAGastos()">
          <i class="fas fa-receipt fa-3x"></i>
          <h3>Gastos</h3>
          <p>Registra y monitorea gastos del proyecto</p>
        </div>
      </div>
    </section>

    <section class="asesoramiento">
      <h2>💡 Innovación para el campo</h2>
      <p>En AgroTechNova impulsamos el desarrollo agroindustrial mediante tecnología, asesoría y proyectos sostenibles que buscan mejorar la productividad y el bienestar de las comunidades rurales.</p>
      <p>Nuestro equipo de expertos está listo para ayudarte a planificar, gestionar y optimizar tus proyectos agroindustriales.</p>
    </section>

  </main>

  <script>
    // Obtener datos del usuario desde localStorage
    const nombreUsuario = localStorage.getItem('nombreUsuario') || 'Usuario';
    const rolUsuario = localStorage.getItem('rolUsuario') || 'productor';
    
    document.getElementById('usuarioNombre').textContent = nombreUsuario;

    // Mostrar/ocultar opción de Gestión de Usuarios según el rol
    const menuUsuarios = document.getElementById('menuUsuarios');
    if (rolUsuario !== 'administrador') {
      menuUsuarios.style.display = 'none';
    }

    function cerrarSesion() {
      // Llamar al endpoint de logout
      fetch('/api/auth/logout', {
        method: 'POST',
        credentials: 'include'
      }).then(() => {
        localStorage.removeItem('nombreUsuario');
        localStorage.removeItem('emailUsuario');
        localStorage.removeItem('rolUsuario');
        window.location.href = 'login.html';
      }).catch(() => {
        // Aunque falle, limpiar localStorage y redirigir
        localStorage.removeItem('nombreUsuario');
        localStorage.removeItem('emailUsuario');
        localStorage.removeItem('rolUsuario');
        window.location.href = 'login.html';
      });
    }

    const menuBtn = document.getElementById('menuBtn');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');

    menuBtn.addEventListener('click', () => {
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    });

    overlay.addEventListener('click', () => {
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
    });

    // Funciones de navegación para Sprint 3
    async function irARecursos() {
      const proyectoId = await obtenerPrimerProyecto();
      if (proyectoId) {
        window.location.href = `recursos.html?proyecto_id=${proyectoId}`;
      } else {
        alert('No tienes proyectos disponibles. Por favor crea un proyecto primero.');
        window.location.href = 'proyectos.html';
      }
    }

    async function irAPresupuestos() {
      const proyectoId = await obtenerPrimerProyecto();
      if (proyectoId) {
        window.location.href = `presupuestos.html?proyecto_id=${proyectoId}`;
      } else {
        alert('No tienes proyectos disponibles. Por favor crea un proyecto primero.');
        window.location.href = 'proyectos.html';
      }
    }

    async function irAGastos() {
      const proyectoId = await obtenerPrimerProyecto();
      if (proyectoId) {
        window.location.href = `gastos.html?proyecto_id=${proyectoId}`;
      } else {
        alert('No tienes proyectos disponibles. Por favor crea un proyecto primero.');
        window.location.href = 'proyectos.html';
      }
    }

    async function obtenerPrimerProyecto() {
      try {
        const response = await fetch('/api/projects');
        if (response.ok) {
          const data = await response.json();
          if (data.projects && data.projects.length > 0) {
            return data.projects[0].id;
          }
        }
      } catch (error) {
        console.error('Error al obtener proyectos:', error);
      }
      return null;
    }
  </script>

</body>
</html>
